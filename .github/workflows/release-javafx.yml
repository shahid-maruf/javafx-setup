name: JavaFX Native Release

on:
  push:
    branches: [ "main" ]
    tags: [ "v*.*.*" ]

permissions:
  contents: write  # Required for release creation

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build project and copy dependencies
        run: mvn clean package dependency:copy-dependencies

      - name: Prepare App Directory
        run: |
          mkdir -p target/app
          mkdir -p target/jpackage
          cp main.jar target/app/main.jar
          cp target/dependency/*.jar target/app/
          # Copy UpdaterTrackivo.jar to root directory
          cp UpdaterTrackivo.jar target/app/

      # ---------------- WINDOWS ----------------
      - name: Create Custom Runtime (Windows)
        if: matrix.os == 'windows-latest'
        shell: cmd
        run: |
          if exist custom-runtime rmdir /s /q custom-runtime
          jlink ^
            --module-path "%JAVA_HOME%\jmods;target\app;javafx-jmods" ^
            --add-modules java.base,java.logging,java.net.http,javafx.controls,javafx.fxml,javafx.media,javafx.graphics,jdk.unsupported,jdk.crypto.ec ^
            --output custom-runtime ^
            --strip-debug ^
            --compress 2 ^
            --no-header-files ^
            --no-man-pages

      - name: Create Windows Installer (MSI)
        if: matrix.os == 'windows-latest'
        shell: cmd
        run: |
          jpackage ^
            --type msi ^
            --input target\app ^
            --dest target\jpackage ^
            --name Trackivo ^
            --main-jar main.jar ^
            --main-class com.itrtechsystems.employeetrackingsystem.Main ^
            --icon resources\com\itrtechsystems\employeetrackingsystem\images\icon\icon.ico ^
            --app-version 1.1 ^
            --vendor "ITR Consulting" ^
            --win-menu ^
            --win-shortcut ^
            --install-dir Trackivo ^
            --runtime-image custom-runtime ^
            --java-options "-Dfile.encoding=UTF-8" ^
            --license-file resources\com\itrtechsystems\employeetrackingsystem\text\LICENSE.txt

      # ---------------- macOS / Linux ----------------
      - name: Create Custom Runtime (macOS/Linux)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          rm -rf custom-runtime
          jlink \
            --module-path "$JAVA_HOME/jmods:target/app:javafx-jmods" \
            --add-modules java.base,java.logging,java.net.http,javafx.controls,javafx.fxml,javafx.media,javafx.graphics,jdk.unsupported,jdk.crypto.ec \
            --output custom-runtime \
            --strip-debug \
            --compress 2 \
            --no-header-files \
            --no-man-pages

      - name: Create macOS Installer (DMG)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          jpackage \
            --type dmg \
            --input target/app \
            --dest target/jpackage \
            --name Trackivo \
            --main-jar main.jar \
            --main-class com.itrtechsystems.employeetrackingsystem.Main \
            --icon resources/com/itrtechsystems/employeetrackingsystem/images/icon/mac-icon.icns \
            --app-version 1.1 \
            --vendor "ITR Consulting" \
            --runtime-image custom-runtime \
            --java-options "-Dfile.encoding=UTF-8"

      - name: Create Linux Installer (DEB)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y fakeroot
          jpackage \
            --type deb \
            --input target/app \
            --dest target/jpackage \
            --name Trackivo \
            --main-jar main.jar \
            --main-class com.itrtechsystems.employeetrackingsystem.Main \
            --icon resources/com/itrtechsystems/employeetrackingsystem/images/icon/favicon-itr-logo.png \
            --app-version 1.1 \
            --vendor "ITR Consulting" \
            --runtime-image custom-runtime \
            --java-options "-Dfile.encoding=UTF-8"

      - name: Upload OS-specific artifact
        uses: actions/upload-artifact@v4
        with:
          name: installers-${{ matrix.os }}
          path: target/jpackage/*

      - name: Upload app files for zip creation
        uses: actions/upload-artifact@v4
        with:
          name: app-files-${{ matrix.os }}
          path: target/app/

  release:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-files

      - name: List downloaded installers
        run: ls -R release-files

      - name: Debug downloaded artifacts
        run: |
          echo "=== Current directory structure ==="
          pwd
          ls -la
          echo "=== Release files content ==="
          ls -la release-files/ || echo "release-files/ doesn't exist"
          echo "=== All files recursively ==="
          find . -name "*.jar" | head -10

      - name: Create app.zip (excluding UpdaterTrackivo.jar)
        run: |
          # Check where the artifacts actually are
          if [ -d "release-files" ]; then
            echo "release-files exists, checking content:"
            ls -la release-files/
            # Try to find app files in subdirectories
            APP_SUBDIR=$(find release-files -name "main.jar" -exec dirname {} \; | head -1)
            if [ -n "$APP_SUBDIR" ]; then
              echo "Found app files in: $APP_SUBDIR"
              cd "$APP_SUBDIR"
            else
              echo "No main.jar found in release-files subdirectories"
              exit 1
            fi
          else
            echo "release-files directory doesn't exist, checking current dir:"
            ls -la
            # Maybe artifacts are in current directory
            if [ -f "main.jar" ]; then
              echo "Found main.jar in current directory"
              cd .
            else
              echo "No app files found!"
              exit 1
            fi
          fi
          
          # Create zip excluding UpdaterTrackivo.jar
          zip -r app.zip ./* -x "UpdaterTrackivo.jar"
          
          # Move zip to appropriate location
          if [ -d "../../release-files" ]; then
            mv app.zip ../../release-files/
          elif [ -d "../release-files" ]; then
            mv app.zip ../release-files/
          else
            # Create release-files directory if it doesn't exist
            mkdir -p release-files
            mv app.zip release-files/
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          files: release-files/**/*