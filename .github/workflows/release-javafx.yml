name: JavaFX Native Release

on:
  push:
    branches: [ "main" ]
    tags: [ "v*.*.*" ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # ---------------- WINDOWS -----------------
      - name: Download JavaFX jmods (Windows)
        if: matrix.os == 'windows-latest'
        shell: cmd
        run: |
          curl -L -o javafx-jmods.zip https://download2.gluonhq.com/openjfx/21.0.8/openjfx-21.0.8_windows-x64_bin-jmods.zip
          tar -xf javafx-jmods.zip
          ren javafx-jmods-21.0.8 javafx-jmods

      # ---------------- macOS -----------------
      - name: Download JavaFX jmods (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          if [ "$(uname -m)" == "arm64" ]; then
            curl -L -o javafx-jmods.zip https://download2.gluonhq.com/openjfx/21.0.8/openjfx-21.0.8_osx-aarch64_bin-jmods.zip
          else
            curl -L -o javafx-jmods.zip https://download2.gluonhq.com/openjfx/21.0.8/openjfx-21.0.8_osx-x64_bin-jmods.zip
          fi
          unzip javafx-jmods.zip
          mv javafx-jmods-21.0.8 javafx-jmods

      # ---------------- Linux -----------------
      - name: Download JavaFX jmods (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          curl -L -o javafx-jmods.zip https://download2.gluonhq.com/openjfx/21.0.8/openjfx-21.0.8_linux-x64_bin-jmods.zip
          unzip javafx-jmods.zip
          mv javafx-jmods-21.0.8 javafx-jmods

      - name: Build project and copy dependencies
        run: mvn clean package dependency:copy-dependencies

      # ---------------- WINDOWS -----------------
      - name: Prepare App Directory (Windows)
        if: matrix.os == 'windows-latest'
        shell: cmd
        run: |
          mkdir target\app
          mkdir target\jpackage
          mkdir target\updater
          copy target\*.jar target\app\
          if exist target\dependency copy target\dependency\*.jar target\app\
          copy UpdaterTrackivo.jar target\updater\UpdaterTrackivo.jar

      # ---------------- macOS / Linux -----------------
      - name: Prepare App Directory (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          mkdir -p target/app
          mkdir -p target/jpackage
          mkdir -p target/updater
          cp target/*.jar target/app/
          if [ -d "target/dependency" ]; then
            cp target/dependency/*.jar target/app/ 2>/dev/null || true
          fi
          cp UpdaterTrackivo.jar target/updater/UpdaterTrackivo.jar

      # ---------------- WINDOWS ----------------
      - name: Create Custom Runtime (Windows)
        if: matrix.os == 'windows-latest'
        shell: cmd
        run: |
          if exist custom-runtime rmdir /s /q custom-runtime
          jlink ^
            --module-path "%JAVA_HOME%\jmods;javafx-jmods" ^
            --add-modules java.base,java.logging,java.net.http,javafx.controls,javafx.fxml,javafx.media,javafx.graphics,jdk.unsupported,jdk.crypto.ec ^
            --output custom-runtime ^
            --strip-debug ^
            --compress 2 ^
            --no-header-files ^
            --no-man-pages

      - name: Create Windows Installer (MSI)
        if: matrix.os == 'windows-latest'
        shell: cmd
        run: |
          jpackage ^
            --type msi ^
            --input target\app ^
            --dest target\jpackage ^
            --name Trackivo ^
            --main-jar main.jar ^
            --main-class com.itrtechsystems.employeetrackingsystem.Main ^
            --icon resources\com\itrtechsystems\employeetrackingsystem\images\icon\icon.ico ^
            --app-version 1.1 ^
            --vendor "ITR Consulting" ^
            --win-menu ^
            --win-shortcut ^
            --install-dir Trackivo ^
            --runtime-image custom-runtime ^
            --java-options "-Dfile.encoding=UTF-8" ^
            --license-file resources\com\itrtechsystems\employeetrackingsystem\text\LICENSE.txt ^
            --resource-dir target\updater ^
            --class-path target\app\*.jar

      # ---------------- macOS / Linux ----------------
      - name: Create Custom Runtime (macOS/Linux)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          rm -rf custom-runtime
          jlink \
            --module-path "$JAVA_HOME/jmods:javafx-jmods" \
            --add-modules java.base,java.logging,java.net.http,javafx.controls,javafx.fxml,javafx.media,javafx.graphics,jdk.unsupported,jdk.crypto.ec \
            --output custom-runtime \
            --strip-debug \
            --compress 2 \
            --no-header-files \
            --no-man-pages

      - name: Create macOS Installer (DMG)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          jpackage \
            --type dmg \
            --input target/app \
            --dest target/jpackage \
            --name Trackivo \
            --main-jar main.jar \
            --main-class com.itrtechsystems.employeetrackingsystem.Main \
            --icon resources/com/itrtechsystems/employeetrackingsystem/images/icon/mac-icon.icns \
            --app-version 1.1 \
            --vendor "ITR Consulting" \
            --runtime-image custom-runtime \
            --java-options "-Dfile.encoding=UTF-8" \
            --resource-dir target/updater \
            --class-path target/app/*.jar

      - name: Create Linux Installer (DEB)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y fakeroot
          jpackage \
            --type deb \
            --input target/app \
            --dest target/jpackage \
            --name Trackivo \
            --main-jar main.jar \
            --main-class com.itrtechsystems.employeetrackingsystem.Main \
            --icon resources/com/itrtechsystems/employeetrackingsystem/images/icon/favicon-itr-logo.png \
            --app-version 1.1 \
            --vendor "ITR Consulting" \
            --runtime-image custom-runtime \
            --java-options "-Dfile.encoding=UTF-8" \
            --resource-dir target/updater \
            --class-path target/app/*.jar

      - name: Upload OS-specific artifact
        uses: actions/upload-artifact@v4
        with:
          name: installers-${{ matrix.os }}
          path: target/jpackage/*

  release:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-files

      - name: List downloaded installers
        run: ls -R release-files

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          files: release-files/**/*